# Отчет

**Config.rs:**

Модуль конфигурации Config предоставляет структуры для хранения настроек приложения, включая URL базы данных и API NASA, а также интервалы опроса различных источников данных. Структура Config содержит поля для строк подключения и вложенную структуру FetchIntervals с интервалами в секундах для получения данных OSDR, ISS, APOD, NEO, DONKI и SpaceX. Метод from_env загружает конфигурацию из переменных окружения с использованием dotenvy, предоставляя значения по умолчанию для необязательных параметров. Функция env_u64 преобразует переменные окружения в числа или использует значения по умолчанию.


**Db.rs:**

Модуль базы данных предоставляет функции для работы с PostgreSQL. Функция create_pool создает пул соединений с максимальным количеством 10 подключений. Функция init_db инициализирует схему базы данных, создавая таблицы iss_fetch_log для логов запросов ISS, osdr_items для хранения данных OSDR с уникальным индексом на dataset_id и space_cache для кеширования пространственных данных. Все таблицы используют тип JSONB для хранения неструктурированных данных и включают временные метки для отслеживания времени создания записей.


**Error.rs:**

Модуль обработки ошибок определяет перечисление AppError с вариантами для ошибок базы данных, внешних API, отсутствия данных и внутренних ошибок. Реализованы преобразования из sqlx::Error и reqwest::Error. Метод status_code возвращает соответствующие HTTP-коды для каждого типа ошибки, а error_code — текстовые коды ошибок. Реализация IntoResponse форматирует ошибки в JSON-ответ с полями ok, error.code, error.message и уникальным trace_id для трассировки. Функция json_success создает успешный JSON-ответ с данными и флагом ok: true. Все ошибки логируются с их trace_id.


**Handlers.rs:**

Модуль handlers реализует HTTP-обработчики для веб-приложения. AppState содержит сервисы IssService и OsdrService для внедрения зависимостей. Хендлер health возвращает статус приложения с текущим временем. Хендлеры last_iss и trigger_iss работают с данными ISS: получение последней позиции и принудительное обновление. Хендлеры osdr_sync и osdr_list управляют данными OSDR: синхронизация с внешним API и получение списка элементов. Упрощенные хендлеры iss_trend, space_latest и space_refresh предоставляют базовую функциональность для трендов ISS и работы с пространственными данными, возвращая упрощенные ответы с заглушками. Все хендлеры возвращают структурированные JSON-ответы через функцию json_success.


**Midleware.rs:**

Модуль trace_layer реализует middleware для трассировки HTTP-запросов. Middleware генерирует уникальный trace_id для каждого запроса, добавляет его в заголовки запроса и ответа, создает информационный span для логов с этим идентификатором, измеряет время выполнения запроса и логирует продолжительность обработки в миллисекундах. Это обеспечивает сквозную трассировку запросов через систему.


**Servics.rs:**

Сервис IssService предоставляет методы для работы с данными ISS: get_last_position извлекает последнюю запись из таблицы iss_fetch_log, а fetch_and_store получает данные из внешнего API по указанному URL и сохраняет их в базу данных. OsdrService управляет данными OSDR: fetch_and_store загружает данные из NASA API, обрабатывает различные форматы ответов и сохраняет или обновляет записи в таблице osdr_items с использованием конфликт-обновления по dataset_id. Метод list возвращает последние записи OSDR с указанным лимитом. Оба сервиса используют пул соединений PostgreSQL и обработку ошибок через AppError.


**Csv_gen.pas:**

Модуль CSVGen реализует генератор CSV-файлов с тестовыми данными для системы мониторинга. Основная функция GenerateCSVFile создает CSV-файл по указанному пути, содержащий заголовки и одну строку данных. Формат данных включает временную метку recorded_at в формате ГГГГ-ММ-ДД ЧЧ:ММ:СС, случайное значение напряжения voltage в диапазоне 3.2-12.6 В, случайную температуру temp в диапазоне -50.0...+80.0°C и имя исходного файла source_file. Для генерации случайных значений используется функция RandFloat, формирующая псевдослучайные числа с плавающей точкой. Данные форматируются с двумя десятичными знаками, временная метка берется из текущего системного времени. Модуль написан на Free Pascal, использует стандартные библиотеки SysUtils и DateUtils, а также модуль Config для работы с конфигурацией.
